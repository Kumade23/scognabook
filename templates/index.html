<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Newsreader%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: Newsreader, "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f0f2f5] px-10 py-3">
          <div class="flex items-center gap-4 text-[#111418]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_6_319)">
                  <path
                    d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z"
                    fill="currentColor"
                  ></path>
                </g>
                <defs>
                  <clipPath id="clip0_6_319"><rect width="48" height="48" fill="white"></rect></clipPath>
                </defs>
              </svg>
            </div>
            <h2 class="text-[#111418] text-lg font-bold leading-tight tracking-[-0.015em]">Bookworm</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8">
            <label class="flex flex-col min-w-40 !h-10 max-w-64">
              <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                <div
                  class="text-[#60748a] flex border-none bg-[#f0f2f5] items-center justify-center pl-4 rounded-l-lg border-r-0"
                  data-icon="MagnifyingGlass"
                  data-size="24px"
                  data-weight="regular"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"
                    ></path>
                  </svg>
                </div>
                <input
                  placeholder="Search"
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border-none bg-[#f0f2f5] focus:border-none h-full placeholder:text-[#60748a] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                  value=""
                />
              </div>
            </label>
            <button
              id="bookmark-button"
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-[#f0f2f5] text-[#111418] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5"
              style="display: none;" <!-- Hidden by default -->
            >
              <div class="text-[#111418]" data-icon="BookmarkSimple" data-size="20px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"
                  ></path>
                </svg>
              </div>
            </button>
            <div id="auth-controls" class="flex items-center gap-2">
                <!-- Links will be populated by JavaScript -->
            </div>
            <div
              id="user-avatar"
              class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
              style='display: none; background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB3OLvOiJmxH2ASQutjuLbySVQeJ5Pp2NyFjSfxuWtb1qJJfR8hJKz73q00m1ySny1jewZDsC6XE4Y9kunoU6QeMOufJ9rKoFGI6cRxq25ONu6r5TSbN0_P56dmlpjTOgZwBXXVXI21TnM5zcioWcNL8WbkBQxrKrVdZa_mETPNsiEtMvxmdFtREBUmq03Ft49OXPQ5lPEIonlS7vbaJeJjl36eESI3shDb-hUcVmNB8J7SeQbcA-aer00yEyd78YZEghv_7aRKbOc");'
            ></div>
          </div>
        </header>
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4">
                <p class="text-[#111418] tracking-light text-[32px] font-bold leading-tight min-w-72" id="library-title">My Library</p>
            </div>
            <div class="px-4 py-3" id="search-bar-container" style="display: none;"> <!-- Hidden by default -->
              <label class="flex flex-col min-w-40 h-12 w-full">
                <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                  <div
                    class="text-[#60748a] flex border-none bg-[#f0f2f5] items-center justify-center pl-4 rounded-l-lg border-r-0"
                    data-icon="MagnifyingGlass"
                    data-size="24px"
                    data-weight="regular"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                      <path
                        d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"
                      ></path>
                    </svg>
                  </div>
                  <input
                    placeholder="Search your library"
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border-none bg-[#f0f2f5] focus:border-none h-full placeholder:text-[#60748a] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                    value=""
                  />
                </div>
              </label>
            </div>
            <!-- Welcome message and auth prompt -->
            <div class="px-4 py-3 text-center">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="main-welcome-message">Welcome to Bookworm</h2>
                <p class="text-gray-600" id="main-prompt-message">
                    Please <a href="/login-page" class="text-blue-500 hover:underline">Login</a> or <a href="/signup-page" class="text-blue-500 hover:underline">Sign Up</a> to manage your library.
                </p>
            </div>
            <h2 class="text-[#111418] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5" id="books-section-title" style="display: none;">Books</h2>
            <div class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4" id="books-grid" style="display: none;">
              <!-- Book items will remain here, but the section will be hidden/shown -->
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAz0MHuPpZcGPeOdC8kWLQiEnCxzgk1ouVL26JJo4jdevqEf3xcX3yYq3U5BUW_P7hyt9aX49cDDNkW25mJ1bSoUXI42NOVnW_E_gs8_wp4fbWDyAFyIuTrbSkkywHLywEXHiq9c68Hp6vZVm9xj_ESfhLcTVCFq0ngsg4aaJKVMbIeUzA3nTSwgHTeIiZyu0XSdgzsORveWytHmzIUBC2F55Hybs3wydO80kspfFJ7hY9NqVmBYTV4wMNeYnmwa4bYQc5nuU_YPu8");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">The Secret Garden</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">Frances Hodgson Burnett</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC_HO7gOwiGWtmwDi8xFDGeX_Z6gL9wCt8qBh8jsEqDQKEaz8Z1KHwq_tmbwqCdKeMmAXyIPD2LjclqvKo9h63qZgr5e5yZ9D722LIWuloqf0fkBM97zS-_yzuSiyZRAJE-vNwx1IdzNVV7rxLlENbNrGFFGp3n2oGKLyIJLKXh3w83AJR8pQOfyJdxrk0lXBD24B-wvQzIAhDsyhNjIGMiobRRZSmkktdhBig_Uo5IH2mfK4ycs5mmyLqACHvCAwJl2-79JSXxioc");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">Pride and Prejudice</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">Jane Austen</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAjgGwzBSe4bvTnpGJTKKDhsKQnDUaYipTvWaahxe78WgvHybqBBspMyd3DT8DFf6yHz8TCQ2peNPxjkWvtZsYN-w1RJKeKE0yTlikxSvmmd1crO5O8EHFxQY3eyNO0IyVA4tpffnL5N59vErp9bgBa5Jam8CbnCKDW9awX37pvuoGoxN_MKnpWEMmIDUTlzTa1aBL5Ml0hrfJXTX8Ui8jFFWTpBBCp3T6EVjTBQDzYNG6nc4nERUGqyrIwwEfm432jSjtOkq9chMo");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">The Great Gatsby</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">F. Scott Fitzgerald</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCCTfiJbmM6OGYsdYvJMyCKTRaXhdbbEcCu_54WtqskBGYLU1RsJVhdEAH3Z5wBvEgfbpRF_334998kk12XfdpGW_MosrXyPICDMCeVwL0odl4La5sQPfXl6yDQtU6BT_iP7P3peYjj0J_ILjF2CrLUSwT_qR3Yj0NI0AtR61fx3RlTpBNUhrzoSaRQkhiWTjS6DL3eAxQTjjfClxKas0VnEb268sClhYiuhS8vOZpVVydEX_ALPRepgIEZNuW6EKRwcPymulyoro4");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">To Kill a Mockingbird</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">Harper Lee</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBfE4OXm62wHNv_kmiCRMxlwEQy3IWYut0ZfkZUdlc164fa6qNkrrUtVAwFFICryoUr9-z5HYjAqnNiwv7xM7LSJ9pwVA-SBmDUpQhU7wVBquuIt1RhLwqslIa16yEqojHGir37gj7KBiVxROkH7jV2W5xfJns6VdVXlKkWAiG-QsXlpCjrEU6vrOxRjVszf3AW7102_mNHYjiG4iBIEUzZcN-8_FIqUXDqBg_8-ynV1MsYz2Ok9pUZU3nqL5pfJ80mjdDlM0VBEw0");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">1984</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">George Orwell</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAkbEWTZ9xkpacokIkRfRVUvZnS9-8uDYiXGVEb8ciLNaqbQZlPCw3htsGQlysZGabP6ON7Fpl34OlMlHSwOXKO4VdDVwiO4mh40RnJlw5DWmzV8zHRF3yr51taxiWJn6OqvhsGNE04fOnbdUggzAg5LGEgO7BN995CZOFzmIR8HwgRD_66CAGEJpllk_twGl8gWCRFxfmJWEMkKCW7523zWnUxngg9NgNtpoVXW0OebaOlodIe7bAheeJM8iDKZyN6kpBgT1m3Z5o");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">The Catcher in the Rye</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">J.D. Salinger</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDpmL4DgcS6BloB_rLKl9cofa86jO96HMQMP7GalNfcX4xsOr9XxcEwHiuxt_c-Dt1yHhzaetsgeXZ4k0flZwpbHPIz1RYiipOZj5XNXUN2OVudymbzi0NNvnl1y4tTiltaLFqyYP1lTBmyQEwCHwJDHv8jTd6G2HpsIKZXLAS9snmm-NOxpj9GH0B1yvZ3JOBIB24GeCf93gwUHOHxqGx0LI3MH7JNog47P5OYl6DpgC0ygxFMBJcbooaNODxjbG6Uot6oouGx5-g");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">The Hobbit</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">J.R.R. Tolkien</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAFvuz6-78nqTj6NFbEkEz4eedf1DoP5zKP-e-wkucfP9uMMmN3KOzEB-atG4jnJDVM3e6f3XO8PLeXaMqkbasTWaq--jmHPu7mXW1Sa5Edq9WCNNkKk6dQCU7ZFCDdw12MeEyhegWLemNhc3Yo6D6rAFnmNb79fw_488zL0aLnh5KHtazCRFZce5QLP4ZnJRO6pEtMh9x6GSFuvD6sXt1kFrwUzuqyamBr5JX_OZ-ymSgSa_tbtlDdiEmMFcVsAAgPapZO3x5jrnQ");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">The Lord of the Rings</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">J.R.R. Tolkien</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDjLBHWKf3Oupqp-xJkAj659CQ_OSxD484mlrBwNLuDc5Ah8iN5cXN-qvFXWOz0ITyGu8WMCON37Tj9G6-uxO_FkJOOZanCtvsBoMvx9Pw0YN60f1fU94h1hNznYfnU7LHBbqU8LbB-yGMrLNQDRQ6Cww_UpAoNukZRAJqhSVF_HiOc3ZreZfwn3g1zEZbDdon8PZLUvZC2QFR6_htswdTMn2xLxaKPQEXZPW7KPRHdrzXcpOFh52-YSAUA8yLwIUMjFomug3ax08o");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">The Chronicles of Narnia</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">C.S. Lewis</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBjY9I3H71XKO0kYR-T0pouFNo0VDpSccfUMZLfLsDhfuy6sdA-p9vy0hEVdAGokqHetRHawP-7_3cAGR7olAbuqzptj5EFf5fGt7KMNBbvbBNlf0-FBeD2GFAZ3GQhb5qlxNqhEe-iN3F8ia11RH1s37fmdxfX3ohlg2NqrzdcTIDXGrFq__wjJVYU_KTCibyriRMXFhVZrE8zesRxelOb6IBE7WKBWCv1o7fSHgcV73UC63aXs7nRmFLpNvZON0WFx31xJRef54k");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">Alice's Adventures in Wonderland</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">Lewis Carroll</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB13runXaNIPmeaBxtA6iYGEj9IqltFb5P2E32RRLlg2mKm6N6vgBJzTXS8pglELHaJypvkdFElburnKqypnD_3far0i_HjcVJw0EBgTGN8UCG0t-eQGqp_BWs5LGerR4_Cgu8pZhyKqiKl8WHHGshJqzxbgWNKKfMF7gz4a-fDYg-EMjbA2CAHKgq6Hpy_oc3deLTd6zW56REXjcl4GLKMlj51X4wucxKIgCJIrjkZ1Id91vZmPMCC9FCErVCTn8BUjWqjV6eQatY");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">Moby Dick</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">Herman Melville</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div
                  class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg"
                  style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD05wKPaKrSPzOkKanFWN65bCORdf5dw4p0y0DX86BAgyat2L_4zUBvjisCk7I9H_-ZyfgyoyfEplUiqBoiS6arjduQ4boCdwCjDl7sTV0QgqVxttZbTuT9h5PErPKP87ybzx9RwHeV4J3v3l5fbWMYluK9t-HHgMYr8Fma6l_42_R54EqGsGdtluVVLzbVtN5hyLg3O-1qJPRm0Y17Wv7EGNAjnfEWzfZOY_piwYl2toTYZhym0U08D9xUcrMH1aMOuPdwpjNTwNI");'
                ></div>
                <div>
                  <p class="text-[#111418] text-base font-medium leading-normal">Frankenstein</p>
                  <p class="text-[#60748a] text-sm font-normal leading-normal">Mary Shelley</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
        async function checkUserSession() {
            const authControls = document.getElementById('auth-controls');
            const bookmarkButton = document.getElementById('bookmark-button');
            const userAvatar = document.getElementById('user-avatar');
            const searchBarContainer = document.getElementById('search-bar-container'); // Existing search bar in the body
            const headerSearchInput = document.querySelector('header input[placeholder="Search"]'); // Header search
            const libraryTitle = document.getElementById('library-title');
            const mainWelcomeMessage = document.getElementById('main-welcome-message');
            const mainPromptMessage = document.getElementById('main-prompt-message');
            const booksSectionTitle = document.getElementById('books-section-title');
            const booksGrid = document.getElementById('books-grid');


            try {
                const response = await fetch('/check_session');
                // It's possible for /check_session to return 401 if @login_required is strict and user is not logged in
                // So we check for response.ok and also specific status codes if needed, or rely on JSON content.
                if (response.ok) {
                    const data = await response.json();
                    if (data.logged_in) {
                        let adminLink = '';
                        if (data.user.is_admin) { // Changed to use data.user.is_admin
                            adminLink = `<a href="/admin/upload-page" class="text-[#111418] hover:text-blue-600 text-sm font-bold ml-2">Upload Book</a>`;
                        }
                        authControls.innerHTML = `
                            <span class="text-[#111418] text-sm font-medium mr-2">Hi, ${data.user.username}</span>
                            <button id="logoutBtn" class="text-[#111418] hover:text-blue-600 text-sm font-bold">Logout</button>
                            ${adminLink}`;
                        document.getElementById('logoutBtn').addEventListener('click', async () => {
                            await fetch('/logout', { method: 'POST' });
                            window.location.reload();
                        });
                        if(userAvatar) userAvatar.style.display = 'block'; // Show avatar
                        if(bookmarkButton) bookmarkButton.style.display = 'flex';
                        if(searchBarContainer) searchBarContainer.style.display = 'block'; // Show main search bar
                        if(headerSearchInput) headerSearchInput.parentElement.parentElement.style.display = 'flex'; // Show header search bar

                        if(libraryTitle) libraryTitle.textContent = `${data.user.username}'s Library`;
                        if(mainWelcomeMessage) mainWelcomeMessage.textContent = 'Manage your books, add new ones, and find your next read.';
                        if(mainPromptMessage) mainPromptMessage.style.display = 'none';
                        if(booksSectionTitle) booksSectionTitle.style.display = 'block';
                        if(booksGrid) {
                            booksGrid.style.display = 'grid';
                            fetchBooksAndDisplay(); // Call function to load books
                        }

                    } else {
                        // This block will be executed if /check_session is accessible by unauthenticated users
                        // and returns {logged_in: false}
                        authControls.innerHTML = `
                            <a href="/login-page" class="text-[#111418] hover:text-blue-600 text-sm font-bold">Login</a>
                            <span class="text-gray-400">/</span>
                            <a href="/signup-page" class="text-[#111418] hover:text-blue-600 text-sm font-bold">Sign Up</a>`;
                        if(userAvatar) userAvatar.style.display = 'none';
                        if(bookmarkButton) bookmarkButton.style.display = 'none';
                        if(searchBarContainer) searchBarContainer.style.display = 'none';
                        if(headerSearchInput) headerSearchInput.parentElement.parentElement.style.display = 'none';

                        if(libraryTitle) libraryTitle.textContent = 'My Library';
                        if(mainWelcomeMessage) mainWelcomeMessage.textContent = 'Welcome to Bookworm';
                        if(mainPromptMessage) mainPromptMessage.style.display = 'block';
                        if(booksSectionTitle) booksSectionTitle.style.display = 'none';
                        if(booksGrid) booksGrid.style.display = 'none';
                    }
                } else {
                     // This handles cases like 401 from @login_required on /check_session
                    authControls.innerHTML = `
                        <a href="/login-page" class="text-[#111418] hover:text-blue-600 text-sm font-bold">Login</a>
                        <span class="text-gray-400">/</span>
                        <a href="/signup-page" class="text-[#111418] hover:text-blue-600 text-sm font-bold">Sign Up</a>`;
                    if(userAvatar) userAvatar.style.display = 'none';
                    if(bookmarkButton) bookmarkButton.style.display = 'none';
                    if(searchBarContainer) searchBarContainer.style.display = 'none';
                    if(headerSearchInput) headerSearchInput.parentElement.parentElement.style.display = 'none';
                    
                    if(libraryTitle) libraryTitle.textContent = 'My Library';
                    if(mainWelcomeMessage) mainWelcomeMessage.textContent = 'Welcome to Bookworm';
                    if(mainPromptMessage) mainPromptMessage.style.display = 'block';
                    if(booksSectionTitle) booksSectionTitle.style.display = 'none';
                    if(booksGrid) booksGrid.style.display = 'none';
                }
            } catch (error) {
                console.error("Error checking session:", error);
                authControls.innerHTML = `
                    <a href="/login-page" class="text-red-500 hover:text-red-700 text-sm font-bold">Login (Error)</a>`;
                // Hide elements as a precaution
                if(userAvatar) userAvatar.style.display = 'none';
                if(bookmarkButton) bookmarkButton.style.display = 'none';
                if(searchBarContainer) searchBarContainer.style.display = 'none';
                if(headerSearchInput) headerSearchInput.parentElement.parentElement.style.display = 'none';

                if(libraryTitle) libraryTitle.textContent = 'My Library';
                if(mainWelcomeMessage) mainWelcomeMessage.textContent = 'Welcome to Bookworm';
                if(mainPromptMessage) mainPromptMessage.style.display = 'block';
                if(booksSectionTitle) booksSectionTitle.style.display = 'none';
                if(booksGrid) booksGrid.style.display = 'none';
            }
        }

        async function fetchBooksAndDisplay(searchTerm = '') { // Add searchTerm parameter
            const booksGrid = document.getElementById('books-grid');
            if (!booksGrid) return;
            booksGrid.innerHTML = ''; // Clear previous books

            let url = '/books';
            if (searchTerm) {
                url += `?q=${encodeURIComponent(searchTerm)}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP error! status: ${response.status}` }));
                    throw new Error(errorData.message || `Error fetching books: ${response.status}`);
                }
                const books = await response.json();

                if (books.length === 0) {
                    if (searchTerm) {
                        booksGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">No books found matching your search.</p>';
                    } else {
                        booksGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Your library is empty. Admins can upload books.</p>';
                    }
                    return;
                }

                books.forEach(book => {
                    const placeholderCover = 'https://via.placeholder.com/158x210.png?text=No+Cover'; // A generic placeholder
                    const coverUrl = book.cover_image_url ? book.cover_image_url : placeholderCover;
                    // Note: book_file_url is for the PDF itself, link to reading page is different
                    const readBookPageUrl = `read_book_page.html?book_id=${book.id}`;


                    const bookCard = `
                        <div class="flex flex-col gap-3 pb-3 book-card-item" data-book-id="${book.id}">
                            <a href="${readBookPageUrl}">
                                <div class="w-full bg-center bg-no-repeat aspect-[3/4] bg-cover rounded-lg bg-gray-200" 
                                     style="background-image: url('${coverUrl}');">
                                    <!-- Fallback for accessibility or if background images are off -->
                                    <img src="${coverUrl}" alt="Cover of ${book.title}" class="w-full aspect-[3/4] rounded-lg object-cover sr-only">
                                </div>
                            </a>
                            <div>
                                <p class="text-[#111418] text-base font-medium leading-normal truncate" title="${book.title}">${book.title}</p>
                                <p class="text-[#60748a] text-sm font-normal leading-normal truncate" title="${book.author || 'Unknown Author'}">${book.author || 'Unknown Author'}</p>
                            </div>
                        </div>
                    `;
                    booksGrid.insertAdjacentHTML('beforeend', bookCard);
                });

            } catch (error) {
                console.error('Failed to fetch books:', error);
                booksGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading books: ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUserSession(); // Initial check

            // Library Search Bar Event Listener
            const librarySearchContainer = document.getElementById('search-bar-container');
            const librarySearchInput = librarySearchContainer.querySelector('input[placeholder="Search your library"]');
            if (librarySearchInput && librarySearchContainer.firstChild.tagName === 'LABEL') {
                const librarySearchForm = document.createElement('form');
                // Move the existing label (which contains the input and its structure) into the form
                librarySearchForm.appendChild(librarySearchContainer.firstChild);
                librarySearchContainer.appendChild(librarySearchForm);

                librarySearchForm.addEventListener('submit', (event) => {
                    event.preventDefault(); 
                    const searchTerm = librarySearchInput.value.trim();
                    fetchBooksAndDisplay(searchTerm);
                });
            }

            // Global Header Search Bar Event Listener
            const globalSearchInput = document.querySelector('header input[placeholder="Search"]');
            if (globalSearchInput) {
                const globalSearchLabel = globalSearchInput.closest('label'); 
                if (globalSearchLabel && globalSearchLabel.parentElement) {
                    const globalSearchForm = document.createElement('form');
                    // Insert the form before the label, then move the label into the form.
                    globalSearchLabel.parentElement.insertBefore(globalSearchForm, globalSearchLabel);
                    globalSearchForm.appendChild(globalSearchLabel);

                    globalSearchForm.addEventListener('submit', (event) => {
                        event.preventDefault();
                        const searchTerm = globalSearchInput.value.trim();
                        fetchBooksAndDisplay(searchTerm);
                    });
                }
            }
        });
    </script>
  </body>
</html>
